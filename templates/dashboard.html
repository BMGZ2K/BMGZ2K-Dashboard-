<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <!-- Plotly.js CDN -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e17;
            color: #e1e5eb;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }
        
        .header .status {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.testnet {
            background: #f59e0b20;
            color: #f59e0b;
            border: 1px solid #f59e0b40;
        }
        
        .status-badge.production {
            background: #10b98120;
            color: #10b981;
            border: 1px solid #10b98140;
        }
        
        .status-badge.halted {
            background: #ef444420;
            color: #ef4444;
            border: 1px solid #ef444440;
        }
        
        .last-update {
            font-size: 12px;
            color: #6b7280;
        }
        
        .container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #151b28;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2d3748;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .metric-change {
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .metric-change.positive {
            color: #10b981;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #3b82f6;
            border-radius: 2px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #2d3748;
        }
        
        th {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            font-size: 14px;
            color: #e1e5eb;
        }
        
        tr:hover {
            background: #1a2234;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-long {
            background: #10b98120;
            color: #10b981;
        }
        
        .badge-short {
            background: #ef444420;
            color: #ef4444;
        }
        
        .badge-strategy {
            background: #3b82f620;
            color: #3b82f6;
        }
        
        .progress-bar {
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.positive {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .progress-fill.negative {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: #0d1117;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .log-line {
            padding: 4px 8px;
            border-bottom: 1px solid #1a2234;
            color: #9ca3af;
            font-size: 11px;
            word-wrap: break-word;
        }
        
        .log-line.info {
            color: #3b82f6;
        }
        
        .log-line.warning {
            color: #f59e0b;
        }
        
        .log-line.error {
            color: #ef4444;
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .fold-bars {
            display: flex;
            gap: 4px;
            margin-top: 10px;
        }
        
        .fold-bar {
            flex: 1;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }
        
        .fold-bar.positive {
            background: #10b98130;
            color: #10b981;
        }
        
        .fold-bar.negative {
            background: #ef444430;
            color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #151b28;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid #2d3748;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #2d3748;
            position: sticky;
            top: 0;
            background: #151b28;
        }

        .modal-header h3 {
            color: #fff;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d3748;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: #1a2234;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-item-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .fold-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .fold-table th,
        .fold-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #2d3748;
        }

        .fold-table th {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .fold-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fold-bar-bg {
            flex: 1;
            height: 20px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }

        .fold-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .strategy-card {
            background: #1a2234;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #3b82f6;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .strategy-card.active {
            border-left-color: #10b981;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .strategy-name {
            font-weight: 600;
            color: #fff;
            font-size: 15px;
        }

        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .strategy-metric {
            text-align: center;
        }

        .strategy-metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .strategy-metric-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .active-badge {
            background: #10b98130;
            color: #10b981;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .params-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .param-tag {
            background: #3b82f620;
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        /* Indicador de conexão */
        .connection-error {
            background: #ef444420;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .connection-error.visible {
            display: block;
        }

        /* Spinner de carregamento */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3b82f640;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Chart containers */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-container {
            background: #151b28;
            border-radius: 12px;
            padding: 20px 24px;
            border: 1px solid #2d3748;
            min-height: 400px;
            overflow: hidden;
        }

        .chart-container.full-width {
            grid-column: 1 / -1;
        }

        .chart-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
        }

        .chart-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .chart-stat-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .chart-stat-label {
            font-size: 10px;
            color: #6b7280;
        }

        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 280px;
            color: #6b7280;
            font-size: 14px;
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Collapsible sections */
        .collapsible-header {
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .collapsible-header:hover {
            opacity: 0.8;
        }

        .collapse-icon {
            font-size: 12px;
            transition: transform 0.3s ease;
            color: #6b7280;
        }

        .collapsible-header.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
            max-height: 2000px;
            opacity: 1;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading Dashboard</h1>
        <div class="status">
            <div class="live-indicator"></div>
            <span id="mode-badge" class="status-badge testnet">TESTNET</span>
            <span id="halted-badge" class="status-badge halted" style="display: none;">HALTED</span>
            <span class="last-update">Atualizado: <span id="last-update">--</span></span>
        </div>
    </div>
    
    <div class="container">
        <!-- Indicador de erro de conexão -->
        <div id="connection-error" class="connection-error">
            Erro de conexão com o servidor. Tentando reconectar...
        </div>

        <!-- Metricas Principais -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Balance</span>
                    <div class="card-icon" style="background: #3b82f620; color: #3b82f6;">$</div>
                </div>
                <div class="metric-value" id="balance">$0.00</div>
                <div class="metric-label">USDT Disponivel</div>
                <div class="metric-change" id="return-pct">0.00%</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Trades</span>
                    <div class="card-icon" style="background: #8b5cf620; color: #8b5cf6;">#</div>
                </div>
                <div class="metric-value" id="total-trades">0</div>
                <div class="metric-label">Total de Trades</div>
                <div id="wins-losses" style="margin-top: 8px; font-size: 13px;">
                    <span style="color: #10b981;">0 wins</span> / 
                    <span style="color: #ef4444;">0 losses</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Win Rate</span>
                    <div class="card-icon" style="background: #10b98120; color: #10b981;">%</div>
                </div>
                <div class="metric-value" id="win-rate">0%</div>
                <div class="metric-label">Taxa de Acerto</div>
                <div class="progress-bar">
                    <div class="progress-fill positive" id="win-rate-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">PnL Total</span>
                    <div class="card-icon" style="background: #f59e0b20; color: #f59e0b;">$</div>
                </div>
                <div class="metric-value" id="total-pnl">$0.00</div>
                <div class="metric-label">Realizado + Não Realizado</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Realizado:</span>
                        <span id="realized-pnl" style="color: #10b981;">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Aberto:</span>
                        <span id="unrealized-pnl" style="color: #3b82f6;">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-top: 4px; border-top: 1px solid #2d3748; padding-top: 4px;">
                        <span style="color: #9ca3af;" title="Comissões de trading">Comissões:</span>
                        <span id="total-commission" style="color: #ef4444;">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;" title="Taxas de funding (pode ser negativo se short)">Funding:</span>
                        <span id="total-funding" style="color: #ef4444;">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Margem</span>
                    <div class="card-icon" style="background: #06b6d420; color: #06b6d4;">◈</div>
                </div>
                <div class="metric-value" id="available-margin">$0</div>
                <div class="metric-label">Margem Disponivel</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Usada:</span>
                        <span id="used-margin" style="color: #f59e0b;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Manutencao:</span>
                        <span id="maint-margin" style="color: #ef4444;">$0</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Risco</span>
                    <div class="card-icon" style="background: #ef444420; color: #ef4444;">⚠</div>
                </div>
                <div class="metric-value" id="margin-ratio">0%</div>
                <div class="metric-label">Margin Ratio</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Margem Usada:</span>
                        <span id="margin-used-pct" style="color: #f59e0b;">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Drawdown:</span>
                        <span id="drawdown" style="color: #ef4444;">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Posicoes</span>
                    <div class="card-icon" style="background: #a855f720; color: #a855f7;">⚡</div>
                </div>
                <div class="metric-value" id="positions-count">0</div>
                <div class="metric-label">Posicoes Abertas</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Notional:</span>
                        <span id="total-notional" style="color: #3b82f6;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Estrategia:</span>
                        <span id="active-strategy" style="color: #a855f7;">--</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Kelly Sizing:</span>
                        <span id="kelly-status" style="color: #10b981;">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status do Bot e Sinais MTF -->
        <div class="section">
            <h2 class="section-title">Status do Bot & Sinais MTF</h2>
            <div class="grid" style="grid-template-columns: 1fr 2fr;">
                <!-- Status do Bot -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Bot Status</span>
                        <div id="bot-status-indicator" class="live-indicator" style="background: #6b7280;"></div>
                    </div>
                    <div id="bot-status-content">
                        <div style="margin-bottom: 15px;">
                            <span id="bot-running-badge" class="status-badge" style="background: #6b728020; color: #6b7280;">OFFLINE</span>
                        </div>
                        <div style="font-size: 13px; color: #9ca3af;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>PID:</span>
                                <span id="bot-pid" style="color: #fff;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Uptime:</span>
                                <span id="bot-uptime" style="color: #fff;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Mode:</span>
                                <span id="bot-mode" style="color: #f59e0b;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span>Timeframes:</span>
                                <span id="bot-timeframes" style="color: #3b82f6;">--</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span>Symbols:</span>
                                <span id="bot-symbols-count" style="color: #10b981;">--</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #2d3748;">
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">Ultimo escaneamento:</div>
                            <div id="bot-scanning" style="font-size: 12px; color: #a855f7; word-wrap: break-word;">--</div>
                        </div>
                    </div>
                </div>

                <!-- Sinais MTF em Tempo Real -->
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Sinais MTF em Tempo Real</span>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <span id="signals-count" style="font-size: 12px; color: #3b82f6;">0 sinais</span>
                            <span id="signals-update" style="font-size: 11px; color: #6b7280;">--</span>
                        </div>
                    </div>
                    <div id="mtf-stats" style="display: flex; gap: 15px; margin-bottom: 15px;">
                        <div style="background: #1a2234; padding: 8px 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #10b981;" id="stats-5m">0</div>
                            <div style="font-size: 10px; color: #6b7280;">5m</div>
                        </div>
                        <div style="background: #1a2234; padding: 8px 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #3b82f6;" id="stats-15m">0</div>
                            <div style="font-size: 10px; color: #6b7280;">15m</div>
                        </div>
                        <div style="background: #1a2234; padding: 8px 15px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 18px; font-weight: 600; color: #f59e0b;" id="stats-1h">0</div>
                            <div style="font-size: 10px; color: #6b7280;">1h</div>
                        </div>
                    </div>
                    <div id="signals-container" style="max-height: 200px; overflow-y: auto;">
                        <div class="no-data">Aguardando sinais do bot...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Posicoes Abertas (PRIMEIRO) -->
        <div class="section">
            <h2 class="section-title">Posicoes Abertas <span id="total-unrealized-pnl" style="font-size: 14px; margin-left: 15px;"></span></h2>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Par</th>
                            <th>Lado</th>
                            <th>Lev</th>
                            <th>Estrategia</th>
                            <th>Entrada</th>
                            <th>Atual</th>
                            <th>Notional</th>
                            <th>PnL</th>
                            <th>SL (dist)</th>
                            <th>TP (dist)</th>
                            <th>Liq. Price</th>
                            <th>Razao</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table">
                        <tr><td colspan="12" class="no-data">Nenhuma posicao aberta</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Graficos de Performance (RETRATIL) -->
        <div class="section">
            <h2 class="section-title collapsible-header collapsed" onclick="toggleSection('charts-section', this)">
                <span class="collapse-icon">&#9660;</span>
                Performance Visual
                <span style="font-size: 12px; color: #6b7280; margin-left: 10px;">(clique para expandir)</span>
            </h2>
            <div id="charts-section" class="collapsible-content collapsed">
                <div class="charts-grid">
                    <!-- Equity Curve -->
                    <div class="chart-container full-width">
                        <div class="chart-title">
                            <span>Equity Curve</span>
                            <div class="chart-stats" id="equity-stats">
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="equity-return">--</span>
                                    <span class="chart-stat-label">Retorno Total</span>
                                </div>
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="equity-hwm">--</span>
                                    <span class="chart-stat-label">High Water Mark</span>
                                </div>
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="equity-trades">--</span>
                                    <span class="chart-stat-label">Total Trades</span>
                                </div>
                            </div>
                        </div>
                        <div id="equity-chart" class="chart-placeholder">Carregando...</div>
                    </div>

                    <!-- Drawdown -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <span>Drawdown</span>
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="max-drawdown-chart" style="color: #ef4444;">--</span>
                                    <span class="chart-stat-label">Max DD</span>
                                </div>
                            </div>
                        </div>
                        <div id="drawdown-chart" class="chart-placeholder">Carregando...</div>
                    </div>

                    <!-- Wins vs Losses -->
                    <div class="chart-container">
                        <div class="chart-title">
                            <span>Wins vs Losses</span>
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="pnl-mean" style="color: #10b981;">--</span>
                                    <span class="chart-stat-label">Media Win</span>
                                </div>
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="pnl-median" style="color: #ef4444;">--</span>
                                    <span class="chart-stat-label">Media Loss</span>
                                </div>
                            </div>
                        </div>
                        <div id="pnl-histogram" class="chart-placeholder">Carregando...</div>
                    </div>

                    <!-- PnL by Symbol -->
                    <div class="chart-container full-width">
                        <div class="chart-title">
                            <span>PnL por Simbolo</span>
                            <div class="chart-stats">
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="best-symbol">--</span>
                                    <span class="chart-stat-label">Melhor</span>
                                </div>
                                <div class="chart-stat">
                                    <span class="chart-stat-value" id="worst-symbol">--</span>
                                    <span class="chart-stat-label">Pior</span>
                                </div>
                            </div>
                        </div>
                        <div id="symbol-chart" class="chart-placeholder">Carregando...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Historico de Trades -->
        <div class="section">
            <h2 class="section-title">Historico de Trades</h2>
            <div class="card">
                <div id="strategy-summary" style="margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap;"></div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Par</th>
                            <th>Lado</th>
                            <th>Estrategia</th>
                            <th>Entrada</th>
                            <th>Saida</th>
                            <th>Qtd</th>
                            <th>PnL</th>
                            <th title="C=Comissão, F=Funding (negativo=recebido)">Taxas</th>
                            <th>%</th>
                            <th>Razao Entrada</th>
                            <th>Razao Saida</th>
                            <th>Horario</th>
                        </tr>
                    </thead>
                    <tbody id="trades-table">
                        <tr><td colspan="12" class="no-data">Nenhum trade registrado</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Estrategias Validadas -->
        <div class="section">
            <h2 class="section-title">Estrategias Validadas (WFO)
                <span id="strategies-count" style="font-size: 14px; margin-left: 15px; color: #3b82f6;"></span>
            </h2>

            <div id="strategies-container">
                <div class="no-data">Carregando estrategias...</div>
            </div>
        </div>

        <!-- Modal de Detalhes da Estratégia -->
        <div id="strategy-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Detalhes da Estratégia</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Conteúdo carregado dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Logs do Sistema -->
        <div class="section">
            <h2 class="section-title">Logs do Sistema</h2>
            <div class="card">
                <div class="logs-container" id="logs-container">
                    <div class="no-data">Carregando logs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURAÇÃO DE INTERVALOS DE ATUALIZAÇÃO =====
        // UNIFICADO: Todos os dados de mercado atualizam juntos
        const UNIFIED_INTERVAL = 1000;  // 1s - Status, Posições, Métricas (dados sincronizados)
        const TRADES_INTERVAL = 3000;   // 3s - Trades (histórico)
        const SLOW_INTERVAL = 10000;    // 10s - Estratégias, Logs

        // Aliases para compatibilidade
        const FAST_INTERVAL = UNIFIED_INTERVAL;
        const MEDIUM_INTERVAL = TRADES_INTERVAL;

        // Timestamp da última atualização bem-sucedida
        let lastSuccessfulUpdate = Date.now();
        const STALE_THRESHOLD_MS = 5000; // 5 segundos

        // Cache local desabilitado - backend já tem cache de 2s
        let statusDataCache = null;
        let statusCacheTime = 0;
        const STATUS_CACHE_TTL = 0; // Sem cache local, usar sempre do backend

        // ===== FUNÇÕES DE SEGURANÇA (Anti-XSS) =====
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ===== FUNÇÕES DE FORMATAÇÃO =====
        function formatCurrency(value, decimals = 2) {
            // Evitar -$0.00 para valores muito pequenos
            const threshold = Math.pow(10, -(decimals + 1)) * 5;
            if (Math.abs(value) < threshold) value = 0;
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        // Formatação de preço inteligente (global)
        function formatPrice(price) {
            if (!price || isNaN(price)) return '$0.00';
            if (price >= 1000) return formatCurrency(price);
            if (price >= 1) return '$' + price.toFixed(4);
            if (price >= 0.01) return '$' + price.toFixed(5);
            return '$' + price.toFixed(8);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Verifica se dados estão desatualizados
        function checkDataStaleness() {
            const now = Date.now();
            const staleDuration = now - lastSuccessfulUpdate;
            const indicator = document.getElementById('last-update');
            const parent = indicator ? indicator.parentElement : null;

            if (staleDuration > STALE_THRESHOLD_MS) {
                if (parent) parent.style.color = '#ef4444';
                if (indicator) indicator.textContent = 'DESATUALIZADO - ' + new Date(lastSuccessfulUpdate).toLocaleTimeString('pt-BR');
            } else {
                if (parent) parent.style.color = '#6b7280';
            }
        }

        function renderFoldBars(foldResults) {
            if (!foldResults || foldResults.length === 0) return '';
            const returns = foldResults.map(f => f.return_pct || 0);
            const maxRet = Math.max(...returns.map(r => Math.abs(r)), 1);

            let barsHtml = foldResults.map((f, i) => {
                const ret = f.return_pct || 0;
                const color = ret >= 0 ? '#10b981' : '#ef4444';
                const heightPct = (Math.abs(ret) / maxRet) * 100;
                return '<div style="flex: 1; display: flex; flex-direction: column; align-items: center;">' +
                    '<div style="background: #1a2234; height: 40px; width: 100%; border-radius: 4px; display: flex; align-items: flex-end; justify-content: center;">' +
                        '<div style="background: ' + color + '; height: ' + Math.max(4, heightPct * 0.4) + 'px; width: 70%; border-radius: 2px;"></div>' +
                    '</div>' +
                    '<span style="font-size: 9px; color: ' + color + '; margin-top: 3px; font-weight: 600;">' + ret.toFixed(0) + '%</span>' +
                    '<span style="font-size: 8px; color: #6b7280;">F' + (i+1) + '</span>' +
                '</div>';
            }).join('');

            return '<div style="margin-top: 12px;">' +
                '<div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">Retorno por Fold (Out-of-Sample):</div>' +
                '<div class="fold-bars" style="display: flex; gap: 4px;">' + barsHtml + '</div>' +
            '</div>';
        }

        function renderFoldTable(folds) {
            if (!folds || folds.length === 0) return '<div class="no-data">Sem detalhes de folds disponíveis</div>';
            const maxRet = Math.max(...folds.map(f => Math.abs(f.return_pct || 0)), 1);

            let rowsHtml = folds.map((f, i) => {
                const ret = f.return_pct || 0;
                const retColor = ret >= 0 ? '#10b981' : '#ef4444';
                const barWidth = (Math.abs(ret) / maxRet) * 100;
                const trainStart = f.train_start ? new Date(f.train_start).toLocaleDateString('pt-BR') : '-';
                const trainEnd = f.train_end ? new Date(f.train_end).toLocaleDateString('pt-BR') : '-';
                const testStart = f.test_start ? new Date(f.test_start).toLocaleDateString('pt-BR') : '-';
                const testEnd = f.test_end ? new Date(f.test_end).toLocaleDateString('pt-BR') : '-';

                return '<tr>' +
                    '<td><strong>Fold ' + (f.fold_number || i+1) + '</strong></td>' +
                    '<td style="font-size: 11px;"><div style="display: flex; align-items: center; gap: 5px;">' +
                        '<span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 2px;"></span>' +
                        '<span>' + trainStart + ' → ' + trainEnd + '</span></div></td>' +
                    '<td style="font-size: 11px;"><div style="display: flex; align-items: center; gap: 5px;">' +
                        '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 2px;"></span>' +
                        '<span>' + testStart + ' → ' + testEnd + '</span></div></td>' +
                    '<td><div class="fold-bar-container">' +
                        '<span style="color: ' + retColor + '; font-weight: 600; min-width: 55px;">' + ret.toFixed(1) + '%</span>' +
                        '<div class="fold-bar-bg" style="width: 80px;"><div class="fold-bar-fill" style="width: ' + barWidth + '%; background: ' + retColor + ';"></div></div>' +
                    '</div></td>' +
                    '<td style="color: #ef4444;">' + (f.max_drawdown_pct || 0).toFixed(1) + '%</td>' +
                    '<td style="color: #3b82f6;">' + (f.sharpe_ratio || 0).toFixed(2) + '</td>' +
                    '<td style="color: #f59e0b;">' + (f.profit_factor || 0).toFixed(2) + '</td>' +
                    '<td>' + (f.win_rate || 0).toFixed(0) + '%</td>' +
                    '<td>' + (f.total_trades || 0) + '</td>' +
                '</tr>';
            }).join('');

            return '<div class="detail-section">' +
                '<div class="detail-section-title">Walk-Forward: Resultados por Fold</div>' +
                '<div style="margin-bottom: 15px; padding: 12px; background: #1a2234; border-radius: 8px; font-size: 12px;">' +
                    '<div style="display: flex; gap: 20px; align-items: center;">' +
                        '<div style="display: flex; align-items: center; gap: 6px;">' +
                            '<span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></span>' +
                            '<span style="color: #9ca3af;">In-Sample (Treino)</span>' +
                        '</div>' +
                        '<div style="display: flex; align-items: center; gap: 6px;">' +
                            '<span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span>' +
                            '<span style="color: #9ca3af;">Out-of-Sample (Teste) - Retornos mostrados</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="overflow-x: auto;"><table class="fold-table"><thead><tr>' +
                    '<th>Fold</th><th>In-Sample (Treino)</th><th>Out-of-Sample (Teste)</th>' +
                    '<th>Retorno OOS</th><th>Max DD</th><th>Sharpe</th><th>PF</th><th>Win Rate</th><th>Trades</th>' +
                '</tr></thead><tbody>' + rowsHtml + '</tbody></table></div>' +
                '<div style="margin-top: 10px; padding: 10px; background: #0d1117; border-radius: 6px; font-size: 11px; color: #6b7280;">' +
                    '<strong>Nota:</strong> Os retornos mostrados são do período Out-of-Sample (dados não vistos durante otimização). ' +
                    'Parâmetros foram otimizados no período In-Sample e testados no Out-of-Sample para validar robustez.' +
                '</div></div>';
        }

        let connectionOk = true;
        let errorCount = 0;

        // Fetch com timeout real usando AbortController
        async function fetchWithTimeout(url, timeoutMs = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (e) {
                clearTimeout(timeoutId);
                throw e;
            }
        }

        async function fetchData(endpoint) {
            try {
                const response = await fetchWithTimeout(endpoint, 10000);  // 10s timeout
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                // Verificar se tem erro na resposta
                if (data.error) {
                    console.warn('API retornou erro:', endpoint, data.error);
                    // Não incrementar errorCount se for erro de dados
                    return data;
                }

                // Conexão OK - atualizar timestamp
                lastSuccessfulUpdate = Date.now();
                if (!connectionOk) {
                    connectionOk = true;
                    errorCount = 0;
                    const errorEl = document.getElementById('connection-error');
                    if (errorEl) errorEl.classList.remove('visible');
                }
                return data;
            } catch (e) {
                if (e.name === 'AbortError') {
                    console.warn('Timeout (10s):', endpoint);
                } else {
                    console.warn('Erro fetch:', endpoint, e.message);
                }
                errorCount++;

                // Mostrar erro após 5 falhas consecutivas (mais tolerante)
                if (errorCount >= 5 && connectionOk) {
                    connectionOk = false;
                    const errorEl = document.getElementById('connection-error');
                    if (errorEl) errorEl.classList.add('visible');
                }
                return null;
            }
        }

        // Função para buscar status com cache local
        async function fetchStatus() {
            const now = Date.now();
            if (statusDataCache && (now - statusCacheTime) < STATUS_CACHE_TTL) {
                return statusDataCache;
            }
            const data = await fetchData('/api/status');
            if (data && !data.error) {
                statusDataCache = data;
                statusCacheTime = now;
            }
            return data;
        }
        
        async function updateStatus() {
            const data = await fetchStatus();
            if (!data || data.error) return;
            
            // Mode badge
            const modeBadge = document.getElementById('mode-badge');
            modeBadge.textContent = data.mode;
            modeBadge.className = 'status-badge ' + (data.mode === 'TESTNET' ? 'testnet' : 'production');
            
            // Halted badge
            const haltedBadge = document.getElementById('halted-badge');
            haltedBadge.style.display = data.is_halted ? 'inline-block' : 'none';
            
            // Last update
            document.getElementById('last-update').textContent = 
                new Date(data.timestamp).toLocaleTimeString('pt-BR');
        }
        
        async function updateMetrics() {
            const data = await fetchStatus();
            if (!data || data.error) return;
            
            // Balance (Margin Balance = wallet + unrealized PnL)
            document.getElementById('balance').textContent = formatCurrency(data.margin_balance || data.wallet_balance || 0);
            
            // Return
            const returnEl = document.getElementById('return-pct');
            returnEl.textContent = formatPercent(data.return_pct || 0);
            returnEl.className = 'metric-change ' + ((data.return_pct || 0) >= 0 ? 'positive' : 'negative');
            
            // Trades
            document.getElementById('total-trades').textContent = data.total_trades || 0;
            document.getElementById('wins-losses').innerHTML = 
                `<span style="color: #10b981;">${data.wins || 0} wins</span> / ` +
                `<span style="color: #ef4444;">${data.losses || 0} losses</span>`;
            
            // Win Rate
            document.getElementById('win-rate').textContent = (data.win_rate || 0).toFixed(1) + '%';
            document.getElementById('win-rate-bar').style.width = (data.win_rate || 0) + '%';
            
            // PnL Total
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = formatCurrency(data.total_pnl || 0);
            pnlEl.style.color = (data.total_pnl || 0) >= 0 ? '#10b981' : '#ef4444';
            
            // PnL Realizado (histórico)
            const realizedEl = document.getElementById('realized-pnl');
            realizedEl.textContent = formatCurrency(data.realized_pnl || 0);
            realizedEl.style.color = (data.realized_pnl || 0) >= 0 ? '#10b981' : '#ef4444';
            
            // PnL Não Realizado (posições abertas)
            const unrealizedEl = document.getElementById('unrealized-pnl');
            unrealizedEl.textContent = formatCurrency(data.unrealized_pnl || 0);
            unrealizedEl.style.color = (data.unrealized_pnl || 0) >= 0 ? '#3b82f6' : '#ef4444';
            
            // Taxas Detalhadas
            // Convenção: POSITIVO = recebeu (ganho/verde), NEGATIVO = pagou (custo/vermelho)
            const commissionEl = document.getElementById('total-commission');
            const totalCommission = data.total_commission || 0;
            commissionEl.textContent = '-' + formatCurrency(totalCommission);  // Sempre negativo (é custo)
            commissionEl.style.color = '#ef4444';

            const fundingEl = document.getElementById('total-funding');
            const totalFunding = data.total_funding || 0;
            fundingEl.textContent = formatCurrency(totalFunding);
            fundingEl.style.color = totalFunding >= 0 ? '#10b981' : '#ef4444';

            // Margem Disponível
            document.getElementById('available-margin').textContent = formatCurrency(data.available_balance || 0);
            document.getElementById('used-margin').textContent = formatCurrency(data.initial_margin || 0);
            document.getElementById('maint-margin').textContent = formatCurrency(data.maint_margin || 0);
            
            // Risco
            const marginRatio = data.margin_ratio || 0;
            const marginRatioEl = document.getElementById('margin-ratio');
            marginRatioEl.textContent = marginRatio.toFixed(2) + '%';
            marginRatioEl.style.color = marginRatio < 50 ? '#10b981' : marginRatio < 80 ? '#f59e0b' : '#ef4444';
            
            document.getElementById('margin-used-pct').textContent = (data.margin_used_pct || 0).toFixed(1) + '%';
            document.getElementById('drawdown').textContent = (data.drawdown_pct || 0).toFixed(2) + '%';
            
            // Posicoes
            document.getElementById('positions-count').textContent = data.open_positions || 0;

            // Kelly Sizing status
            const kellyEl = document.getElementById('kelly-status');
            if (data.use_kelly) {
                kellyEl.textContent = 'ON';
                kellyEl.style.color = '#10b981';
            } else {
                kellyEl.textContent = 'OFF';
                kellyEl.style.color = '#6b7280';
            }
        }
        
        async function updatePositions() {
            const data = await fetchData('/api/positions');
            if (!data) return;
            
            document.getElementById('positions-count').textContent = data.count;
            
            // Mostrar PnL total nao realizado
            const totalPnl = data.total_unrealized_pnl || 0;
            const totalPnlEl = document.getElementById('total-unrealized-pnl');
            totalPnlEl.textContent = `PnL Aberto: ${formatCurrency(totalPnl)}`;
            totalPnlEl.style.color = totalPnl >= 0 ? '#10b981' : '#ef4444';
            
            // Calcular notional total
            const totalNotional = data.positions.reduce((sum, p) => sum + (p.notional || 0), 0);
            document.getElementById('total-notional').textContent = '$' + totalNotional.toLocaleString('en-US', {maximumFractionDigits: 0});
            
            const tbody = document.getElementById('positions-table');
            
            if (data.positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">Nenhuma posicao aberta</td></tr>';
                totalPnlEl.textContent = 'PnL Aberto: $0.00';
                totalPnlEl.style.color = '#6b7280';
                document.getElementById('total-notional').textContent = '$0';
                return;
            }

            tbody.innerHTML = data.positions.map(p => {
                const pnlColor = p.unrealized_pnl >= 0 ? '#10b981' : '#ef4444';
                const sideClass = p.side === 'long' ? 'badge-long' : 'badge-short';
                const entryTime = new Date(p.entry_time).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                // Usar formatPrice global (já definida acima)
                
                return `
                    <tr>
                        <td><strong>${p.symbol}</strong></td>
                        <td><span class="badge ${sideClass}">${p.side.toUpperCase()}</span></td>
                        <td><span style="color: #a855f7; font-weight: 600;">${p.leverage}x</span></td>
                        <td><span class="badge badge-strategy">${p.strategy || 'N/A'}</span></td>
                        <td>${formatPrice(p.entry_price)}</td>
                        <td>${formatPrice(p.current_price)}</td>
                        <td>$${p.notional.toLocaleString()}</td>
                        <td style="color: ${pnlColor}; font-weight: 600;">
                            ${formatCurrency(p.unrealized_pnl, 3)}<br>
                            <span style="font-size: 10px;">${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(3)}%</span>
                        </td>
                        <td style="color: #ef4444;">
                            ${p.stop_loss > 0 ? formatPrice(p.stop_loss) : '-'}<br>
                            <span style="font-size: 10px;">${p.stop_loss > 0 ? p.sl_distance + '%' : '-'}</span>
                        </td>
                        <td style="color: #10b981;">
                            ${p.take_profit > 0 ? formatPrice(p.take_profit) : '-'}<br>
                            <span style="font-size: 10px;">${p.take_profit > 0 ? p.tp_distance + '%' : '-'}</span>
                        </td>
                        <td style="color: #f59e0b; font-size: 11px;">
                            ${p.liquidation_price > 0 ? formatPrice(p.liquidation_price) : '-'}
                        </td>
                        <td style="font-size: 10px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${p.reason_entry || ''}">
                            ${p.reason_entry || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Armazenar dados das estratégias para o modal
        let strategiesData = [];

        async function updateStrategies() {
            const data = await fetchData('/api/strategies');
            if (!data) return;

            document.getElementById('active-strategy').textContent = data.active_strategy;
            strategiesData = data.validated_strategies || [];

            const container = document.getElementById('strategies-container');
            const countEl = document.getElementById('strategies-count');

            if (countEl) {
                countEl.textContent = `${data.total_strategies || 0} estratégias | ${data.active_count || 0} ativas`;
            }

            if (!strategiesData.length) {
                container.innerHTML = '<div class="no-data">Nenhuma estrategia validada. Execute o auto_evolve.py para criar.</div>';
                return;
            }

            container.innerHTML = strategiesData.map((s, idx) => {
                const robustnessColor = s.robustness >= 70 ? '#10b981' : s.robustness >= 40 ? '#f59e0b' : '#ef4444';
                const robustnessBg = robustnessColor + '20';
                const returnColor = (s.avg_return || 0) >= 0 ? '#10b981' : '#ef4444';

                return '<div class="strategy-card' + (s.is_active ? ' active' : '') + '" onclick="showStrategyDetail(\'' + escapeHtml(s.id) + '\')">' +
                    '<div class="strategy-header">' +
                        '<div>' +
                            '<span class="strategy-name">' + escapeHtml(s.name || s.strategy_type) + '</span>' +
                            (s.is_active ? '<span class="active-badge" style="margin-left: 10px;">ATIVA</span>' : '') +
                        '</div>' +
                        '<div style="display: flex; gap: 10px; align-items: center;">' +
                            '<span class="badge badge-strategy">' + s.num_folds + ' folds</span>' +
                            '<span class="badge" style="background: ' + robustnessBg + '; color: ' + robustnessColor + ';">' +
                                (s.robustness || 0).toFixed(0) + '% robusto' +
                            '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="strategy-metrics">' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: ' + returnColor + ';">' + (s.avg_return || 0).toFixed(1) + '%</div>' +
                            '<div class="strategy-metric-label">Ret/Fold OOS</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="font-size: 14px; color: #9ca3af;">' + (s.min_return || 0).toFixed(0) + '/' + (s.max_return || 0).toFixed(0) + '%</div>' +
                            '<div class="strategy-metric-label">Min/Max</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #ef4444;">' + (s.max_drawdown || 0).toFixed(1) + '%</div>' +
                            '<div class="strategy-metric-label">Max DD</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #3b82f6;">' + (s.avg_sharpe || 0).toFixed(2) + '</div>' +
                            '<div class="strategy-metric-label">Sharpe</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #f59e0b;">' + (s.avg_profit_factor || 0).toFixed(2) + '</div>' +
                            '<div class="strategy-metric-label">Profit Factor</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #a855f7;">' + (s.avg_win_rate || 0).toFixed(0) + '%</div>' +
                            '<div class="strategy-metric-label">Win Rate</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #06b6d4;">' + (s.total_trades || 0) + '</div>' +
                            '<div class="strategy-metric-label">Trades</div>' +
                        '</div>' +
                    '</div>' +
                    (s.fold_results && s.fold_results.length > 0 ? renderFoldBars(s.fold_results) : '') +
                    '<div style="margin-top: 10px; font-size: 11px; color: #6b7280;">' +
                        'Clique para ver detalhes completos' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        async function showStrategyDetail(strategyId) {
            const modal = document.getElementById('strategy-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');

            modalBody.innerHTML = '<div class="no-data">Carregando...</div>';
            modal.style.display = 'flex';

            try {
                const data = await fetchData(`/api/strategies/${strategyId}`);
                if (!data || data.error) {
                    modalBody.innerHTML = `<div class="no-data">Erro: ${data?.error || 'Estratégia não encontrada'}</div>`;
                    return;
                }

                modalTitle.textContent = `${data.name} - Detalhes Completos`;

                const metrics = data.metrics || {};
                const wfo = data.wfo || {};
                const status = data.status || {};
                const folds = wfo.fold_results || [];

                modalBody.innerHTML = `
                    <!-- Status -->
                    <div class="detail-section">
                        <div class="detail-section-title">Status</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Status</div>
                                <div class="detail-item-value" style="color: ${status.is_active ? '#10b981' : '#6b7280'};">
                                    ${status.is_active ? 'ATIVA' : 'INATIVA'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Tipo</div>
                                <div class="detail-item-value">${data.strategy_type}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Timeframe</div>
                                <div class="detail-item-value">${data.timeframe}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Símbolos</div>
                                <div class="detail-item-value">${(data.symbols || []).length}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Criada em</div>
                                <div class="detail-item-value" style="font-size: 12px;">
                                    ${status.created_at ? new Date(status.created_at).toLocaleString('pt-BR') : '-'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Último Uso</div>
                                <div class="detail-item-value" style="font-size: 12px;">
                                    ${status.last_used ? new Date(status.last_used).toLocaleString('pt-BR') : 'Nunca'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas WFO -->
                    <div class="detail-section">
                        <div class="detail-section-title">Métricas WFO (${wfo.num_folds} Folds)</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Retorno Médio</div>
                                <div class="detail-item-value" style="color: ${metrics.avg_return >= 0 ? '#10b981' : '#ef4444'};">
                                    ${(metrics.avg_return || 0).toFixed(2)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Retorno Min/Max</div>
                                <div class="detail-item-value" style="font-size: 14px;">
                                    <span style="color: #ef4444;">${(metrics.min_return || 0).toFixed(1)}%</span> /
                                    <span style="color: #10b981;">${(metrics.max_return || 0).toFixed(1)}%</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Desvio Padrão</div>
                                <div class="detail-item-value">${(metrics.std_return || 0).toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Max Drawdown</div>
                                <div class="detail-item-value" style="color: #ef4444;">
                                    ${(metrics.max_drawdown || 0).toFixed(2)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Sharpe Médio</div>
                                <div class="detail-item-value" style="color: #3b82f6;">
                                    ${(metrics.avg_sharpe || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Sortino Médio</div>
                                <div class="detail-item-value" style="color: #8b5cf6;">
                                    ${(metrics.avg_sortino || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Profit Factor</div>
                                <div class="detail-item-value" style="color: #f59e0b;">
                                    ${(metrics.avg_profit_factor || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Win Rate</div>
                                <div class="detail-item-value">${(metrics.avg_win_rate || 0).toFixed(1)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Score WFO</div>
                                <div class="detail-item-value" style="color: #06b6d4;">
                                    ${(wfo.wfo_score || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Robustez</div>
                                <div class="detail-item-value" style="color: ${(wfo.robustness || wfo.robustness_score || 0) >= 70 ? '#10b981' : '#f59e0b'};">
                                    ${(wfo.robustness || wfo.robustness_score || 0).toFixed(1)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Total Trades</div>
                                <div class="detail-item-value">${metrics.total_trades || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalhes por Fold -->
                    ` + renderFoldTable(folds) + `

                    <!-- Parâmetros -->
                    <div class="detail-section">
                        <div class="detail-section-title">Parâmetros da Estratégia</div>
                        <div class="params-list">
                            ${Object.entries(data.params || {}).map(([k, v]) =>
                                `<span class="param-tag">${k}: ${typeof v === 'number' ? v.toFixed ? v.toFixed(2) : v : v}</span>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Performance Real -->
                    <div class="detail-section">
                        <div class="detail-section-title">Performance Real (Live Trading)</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Trades Reais</div>
                                <div class="detail-item-value">${data.real_performance?.trades || 0}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">PnL Real</div>
                                <div class="detail-item-value" style="color: ${(data.real_performance?.pnl || 0) >= 0 ? '#10b981' : '#ef4444'};">
                                    ${formatCurrency(data.real_performance?.pnl || 0)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Win Rate Real</div>
                                <div class="detail-item-value">${(data.real_performance?.win_rate || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                modalBody.innerHTML = `<div class="no-data">Erro ao carregar: ${e.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('strategy-modal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('strategy-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        async function updateTrades() {
            const data = await fetchData('/api/trades');
            if (!data) return;
            
            // Resumo por estrategia
            const summaryContainer = document.getElementById('strategy-summary');
            const stratStats = data.strategy_stats || {};
            
            if (Object.keys(stratStats).length > 0) {
                summaryContainer.innerHTML = Object.entries(stratStats).map(([strat, stats]) => `
                    <div style="background: #1a2234; padding: 10px 15px; border-radius: 8px; min-width: 150px;">
                        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase;">${strat}</div>
                        <div style="font-size: 18px; font-weight: 600; color: ${stats.pnl >= 0 ? '#10b981' : '#ef4444'};">
                            ${formatCurrency(stats.pnl)}
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            ${stats.trades} trades | ${stats.win_rate.toFixed(1)}% WR
                        </div>
                    </div>
                `).join('');
            } else {
                summaryContainer.innerHTML = '';
            }
            
            // Tabela de trades
            const tbody = document.getElementById('trades-table');
            const trades = data.recent_trades || [];
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">Nenhum trade registrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(t => {
                const pnlColor = t.pnl >= 0 ? '#10b981' : '#ef4444';
                const sideClass = t.side === 'long' ? 'badge-long' : 'badge-short';
                const exitTime = new Date(t.exit_time).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                // Formatar quantidade de forma inteligente
                const qty = parseFloat(t.quantity);
                const qtyFormatted = qty >= 1000 ? qty.toLocaleString('en-US', {maximumFractionDigits: 2}) :
                                     qty >= 1 ? qty.toFixed(4) : qty.toPrecision(4);
                const commission = t.commission || 0;
                const funding = t.funding_cost || 0;
                // Convenção: POSITIVO = recebeu (verde), NEGATIVO = pagou (vermelho)
                const fundingColor = funding >= 0 ? '#10b981' : '#ef4444';

                return `
                    <tr>
                        <td>${t.id || '-'}</td>
                        <td><strong>${t.symbol}</strong></td>
                        <td><span class="badge ${sideClass}">${t.side.toUpperCase()}</span></td>
                        <td><span class="badge badge-strategy">${t.strategy || 'N/A'}</span></td>
                        <td>${formatPrice(t.entry_price)}</td>
                        <td>${formatPrice(t.exit_price)}</td>
                        <td>${qtyFormatted}</td>
                        <td style="color: ${pnlColor}; font-weight: 600;">${formatCurrency(t.pnl)}</td>
                        <td style="font-size: 11px;">
                            <div style="color: #ef4444;">C: -${formatCurrency(commission)}</div>
                            <div style="color: ${fundingColor};">F: ${formatCurrency(funding)}</div>
                        </td>
                        <td style="color: ${pnlColor};">${(t.pnl_pct || 0).toFixed(2)}%</td>
                        <td style="font-size: 11px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${t.reason_entry || '-'}</td>
                        <td style="font-size: 11px;">${t.reason_exit || '-'}</td>
                        <td style="font-size: 11px;">${exitTime}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function updateLogs() {
            const data = await fetchData('/api/logs');
            if (!data || !data.logs) return;
            
            const container = document.getElementById('logs-container');
            
            if (data.logs.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum log disponivel</div>';
                return;
            }
            
            container.innerHTML = data.logs.slice(-50).map(log => {
                let className = 'log-line';
                if (log.includes('ERROR')) className += ' error';
                else if (log.includes('WARNING')) className += ' warning';
                else if (log.includes('INFO')) className += ' info';
                return `<div class="${className}">${log}</div>`;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        // ===== FUNÇÕES DE ATUALIZAÇÃO AGRUPADAS =====
        async function updateUnified() {
            // CRÍTICO: Status, Métricas e Posições DEVEM atualizar juntos
            // Isso garante que os dados exibidos sejam consistentes
            // O backend sincroniza account+tickers de uma vez, então aqui
            // fazemos as 3 chamadas em paralelo (usam mesmo cache no backend)
            try {
                await Promise.all([
                    updateStatus(),
                    updateMetrics(),
                    updatePositions()
                ]);
            } catch (e) {
                console.error('Erro na atualização unificada:', e);
            }
        }

        // Alias para compatibilidade
        const updateFast = updateUnified;

        async function updateMedium() {
            // Trades (histórico)
            await updateTrades();
        }

        async function updateSlow() {
            // Estratégias e Logs (15s)
            await Promise.all([
                updateStrategies(),
                updateLogs()
            ]);
        }

        async function updateAll() {
            // Carrega tudo - unificado primeiro, depois o resto
            await updateUnified();
            await updateMedium();
            await updateSlow();
            await updateBotStatus();
            await updateSignals();
        }

        // ===== BOT STATUS E SINAIS MTF =====
        async function updateBotStatus() {
            const data = await fetchData('/api/bot-status');
            if (!data) return;

            // Indicador de status
            const indicator = document.getElementById('bot-status-indicator');
            const badge = document.getElementById('bot-running-badge');

            if (data.running) {
                indicator.style.background = '#10b981';
                badge.textContent = 'ONLINE';
                badge.style.background = '#10b98120';
                badge.style.color = '#10b981';
            } else {
                indicator.style.background = '#ef4444';
                badge.textContent = 'OFFLINE';
                badge.style.background = '#ef444420';
                badge.style.color = '#ef4444';
            }

            // Detalhes
            document.getElementById('bot-pid').textContent = data.pid || '--';
            document.getElementById('bot-uptime').textContent = data.uptime_formatted || '--';
            document.getElementById('bot-mode').textContent = data.mode || '--';
            document.getElementById('bot-timeframes').textContent = (data.active_timeframes || []).join(', ') || '--';
            document.getElementById('bot-symbols-count').textContent = data.symbols_count || '--';

            // Simbolos escaneados
            const scanning = data.scanning_symbols || [];
            document.getElementById('bot-scanning').textContent = scanning.length > 0
                ? scanning.join(', ')
                : 'Nenhum sinal recente';
        }

        async function updateSignals() {
            const data = await fetchData('/api/signals');
            if (!data) return;

            // Contador e ultima atualizacao
            document.getElementById('signals-count').textContent = `${data.total_signals || 0} sinais`;
            if (data.last_update) {
                const updateTime = new Date(data.last_update).toLocaleTimeString('pt-BR');
                document.getElementById('signals-update').textContent = updateTime;
            }

            // Stats por timeframe
            const stats = data.mtf_stats || {};
            document.getElementById('stats-5m').textContent = stats['5m'] || 0;
            document.getElementById('stats-15m').textContent = stats['15m'] || 0;
            document.getElementById('stats-1h').textContent = stats['1h'] || 0;

            // Sinais
            const container = document.getElementById('signals-container');
            const signals = data.signals || [];

            if (signals.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum sinal ativo no momento</div>';
                return;
            }

            container.innerHTML = signals.map(s => {
                const sideColor = s.side.toLowerCase() === 'buy' ? '#10b981' : '#ef4444';
                const sideIcon = s.side.toLowerCase() === 'buy' ? '[+]' : '[-]';
                const tfColor = {'5m': '#10b981', '15m': '#3b82f6', '1h': '#f59e0b'}[s.timeframe] || '#9ca3af';

                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: #1a2234; border-radius: 6px; margin-bottom: 6px;">
                        <span style="color: ${sideColor}; font-weight: 600; font-size: 13px;">${sideIcon}</span>
                        <span style="font-weight: 600; color: #fff; min-width: 80px;">${s.symbol}</span>
                        <span style="background: ${tfColor}20; color: ${tfColor}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${s.timeframe}</span>
                        <span style="color: #a855f7; font-size: 12px;">Str: ${s.strength}</span>
                        ${s.aligned_count > 0 ? `<span style="color: #3b82f6; font-size: 11px;">${s.aligned_count} TF aligned</span>` : ''}
                        <span style="margin-left: auto; color: #6b7280; font-size: 11px;">${formatPrice(s.price)}</span>
                    </div>
                `;
            }).join('');
        }

        // ===== INICIAR ATUALIZAÇÕES =====
        // Carregar tudo inicialmente (com pequeno delay para dar tempo ao servidor)
        setTimeout(updateAll, 500);

        // Intervalos sincronizados:
        // - Dados de mercado (status/posições/métricas): juntos a cada 1s
        // - Trades: a cada 3s
        // - Estratégias/logs: a cada 10s
        setInterval(updateUnified, UNIFIED_INTERVAL);  // 1s - TUDO sincronizado
        setInterval(updateMedium, TRADES_INTERVAL);    // 3s - trades
        setInterval(updateSlow, SLOW_INTERVAL);        // 10s - estratégias e logs
        setInterval(updateBotStatus, TRADES_INTERVAL); // 3s - status do bot
        setInterval(updateSignals, TRADES_INTERVAL);   // 3s - sinais MTF

        // Verificar dados desatualizados a cada 2s
        setInterval(checkDataStaleness, 2000);

        // Fechar modal com Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('strategy-modal');
                if (modal && modal.style.display === 'flex') {
                    closeModal();
                }
            }
        });

        // ===== COLLAPSIBLE SECTIONS =====
        let chartsLoaded = false;

        function toggleSection(sectionId, headerElement) {
            const content = document.getElementById(sectionId);
            const isCollapsed = content.classList.contains('collapsed');

            if (isCollapsed) {
                // Expandir
                content.classList.remove('collapsed');
                headerElement.classList.remove('collapsed');
                headerElement.querySelector('span:last-child').textContent = '(clique para retrair)';

                // Carregar graficos apenas quando expandir pela primeira vez
                if (!chartsLoaded) {
                    chartsLoaded = true;
                    setTimeout(updateCharts, 100);
                }
            } else {
                // Retrair
                content.classList.add('collapsed');
                headerElement.classList.add('collapsed');
                headerElement.querySelector('span:last-child').textContent = '(clique para expandir)';
            }
        }

        // ===== PLOTLY CHART CONFIGURATION =====
        const plotlyDarkLayout = {
            paper_bgcolor: '#151b28',
            plot_bgcolor: '#151b28',
            font: { color: '#9ca3af', family: 'Segoe UI, sans-serif' },
            margin: { l: 50, r: 30, t: 30, b: 50 },
            xaxis: {
                gridcolor: '#2d3748',
                linecolor: '#2d3748',
                zerolinecolor: '#2d3748'
            },
            yaxis: {
                gridcolor: '#2d3748',
                linecolor: '#2d3748',
                zerolinecolor: '#2d3748'
            },
            showlegend: false
        };

        const plotlyConfig = {
            displayModeBar: false,
            responsive: true
        };

        // ===== CHART FUNCTIONS =====

        // Equity Curve + High Water Mark
        async function updateEquityChart() {
            const data = await fetchData('/api/equity-history');
            if (!data || data.error || !data.equity_curve || data.equity_curve.length < 2) {
                document.getElementById('equity-chart').innerHTML = '<div class="chart-placeholder">Sem dados de equity</div>';
                return;
            }

            // Update stats
            const returnPct = data.total_return_pct || 0;
            document.getElementById('equity-return').textContent = formatPercent(returnPct);
            document.getElementById('equity-return').style.color = returnPct >= 0 ? '#10b981' : '#ef4444';
            document.getElementById('equity-hwm').textContent = formatCurrency(data.high_water_mark || 0);
            document.getElementById('equity-trades').textContent = data.total_trades || 0;

            const curve = data.equity_curve;
            const timestamps = curve.map(p => new Date(p.timestamp));
            const equities = curve.map(p => p.equity);

            // Calculate HWM line
            let hwmLine = [];
            let currentHwm = equities[0] || 0;
            for (let e of equities) {
                currentHwm = Math.max(currentHwm, e);
                hwmLine.push(currentHwm);
            }

            const traces = [
                {
                    x: timestamps,
                    y: equities,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Equity',
                    line: { color: '#3b82f6', width: 2 },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(59, 130, 246, 0.1)'
                },
                {
                    x: timestamps,
                    y: hwmLine,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'HWM',
                    line: { color: '#10b981', width: 1, dash: 'dot' }
                }
            ];

            const layout = {
                ...plotlyDarkLayout,
                showlegend: true,
                legend: { orientation: 'h', y: -0.2, font: { color: '#9ca3af' } },
                yaxis: { ...plotlyDarkLayout.yaxis, tickprefix: '$', automargin: true },
                xaxis: { ...plotlyDarkLayout.xaxis, automargin: true },
                margin: { l: 70, r: 30, t: 20, b: 70 },
                height: 320
            };

            // Limpar container e remover classe placeholder antes de renderizar
            const container = document.getElementById('equity-chart');
            container.innerHTML = '';
            container.classList.remove('chart-placeholder');
            Plotly.newPlot(container, traces, layout, plotlyConfig);
        }

        // Drawdown Chart
        async function updateDrawdownChart() {
            const data = await fetchData('/api/equity-history');
            if (!data || data.error || !data.equity_curve || data.equity_curve.length < 2) {
                document.getElementById('drawdown-chart').innerHTML = '<div class="chart-placeholder">Sem dados de drawdown</div>';
                return;
            }

            document.getElementById('max-drawdown-chart').textContent = `-${(data.max_drawdown || 0).toFixed(2)}%`;

            const curve = data.equity_curve;
            const timestamps = curve.map(p => new Date(p.timestamp));
            const drawdowns = curve.map(p => -p.drawdown);  // Negative for visual

            const trace = {
                x: timestamps,
                y: drawdowns,
                type: 'scatter',
                mode: 'lines',
                fill: 'tozeroy',
                fillcolor: 'rgba(239, 68, 68, 0.3)',
                line: { color: '#ef4444', width: 1 }
            };

            const layout = {
                ...plotlyDarkLayout,
                yaxis: { ...plotlyDarkLayout.yaxis, ticksuffix: '%', automargin: true },
                xaxis: { ...plotlyDarkLayout.xaxis, automargin: true },
                margin: { l: 60, r: 30, t: 20, b: 60 },
                height: 300
            };

            // Limpar container e remover classe placeholder antes de renderizar
            const container = document.getElementById('drawdown-chart');
            container.innerHTML = '';
            container.classList.remove('chart-placeholder');
            Plotly.newPlot(container, [trace], layout, plotlyConfig);
        }

        // Wins vs Losses - Barras verticais simples
        async function updatePnLHistogram() {
            const data = await fetchData('/api/pnl-distribution');
            if (!data || data.error || !data.pnls || data.pnls.length === 0) {
                document.getElementById('pnl-histogram').innerHTML = '<div class="chart-placeholder">Sem dados de PnL</div>';
                return;
            }

            const pnls = data.pnls;
            const wins = pnls.filter(p => p >= 0);
            const losses = pnls.filter(p => p < 0);

            const avgWin = wins.length > 0 ? wins.reduce((a, b) => a + b, 0) / wins.length : 0;
            const avgLoss = losses.length > 0 ? Math.abs(losses.reduce((a, b) => a + b, 0) / losses.length) : 0;
            const totalWin = wins.reduce((a, b) => a + b, 0);
            const totalLoss = Math.abs(losses.reduce((a, b) => a + b, 0));

            // Update stats no header
            document.getElementById('pnl-mean').textContent = formatCurrency(avgWin);
            document.getElementById('pnl-median').textContent = formatCurrency(-avgLoss);

            // Barras verticais: Wins (verde, positivo) e Losses (vermelho, negativo)
            const trace = {
                x: ['Wins', 'Losses'],
                y: [totalWin, -totalLoss],
                type: 'bar',
                marker: {
                    color: ['#10b981', '#ef4444']
                },
                text: [
                    formatCurrency(totalWin),
                    formatCurrency(-totalLoss)
                ],
                textposition: 'inside',
                textfont: { color: '#ffffff', size: 14, family: 'Segoe UI, sans-serif' },
                insidetextanchor: 'middle',
                hovertemplate: '<b>%{x}</b><br>%{customdata} trades<br>%{text}<extra></extra>',
                customdata: [wins.length, losses.length]
            };

            // Calcular range do eixo Y com margem para mostrar valores
            const maxVal = Math.max(totalWin, totalLoss);
            const yRange = [-maxVal * 1.15, maxVal * 1.15];

            const layout = {
                ...plotlyDarkLayout,
                xaxis: { ...plotlyDarkLayout.xaxis, type: 'category', automargin: true },
                yaxis: {
                    ...plotlyDarkLayout.yaxis,
                    tickprefix: '$',
                    zeroline: true,
                    zerolinecolor: '#6b7280',
                    zerolinewidth: 1,
                    automargin: true,
                    range: yRange
                },
                height: 300,
                bargap: 0.3,
                margin: { l: 70, r: 30, t: 30, b: 50 },
                annotations: [
                    {
                        x: 'Wins',
                        y: totalWin,
                        text: wins.length + ' trades',
                        showarrow: false,
                        yshift: 15,
                        font: { color: '#10b981', size: 11 }
                    },
                    {
                        x: 'Losses',
                        y: -totalLoss,
                        text: losses.length + ' trades',
                        showarrow: false,
                        yshift: -15,
                        font: { color: '#ef4444', size: 11 }
                    }
                ]
            };

            const container = document.getElementById('pnl-histogram');
            container.innerHTML = '';
            container.classList.remove('chart-placeholder');
            Plotly.newPlot(container, [trace], layout, plotlyConfig);
        }

        // PnL by Symbol Chart
        async function updateSymbolChart() {
            const data = await fetchData('/api/pnl-by-symbol');
            if (!data || data.error || !data.symbols || data.symbols.length === 0) {
                document.getElementById('symbol-chart').innerHTML = '<div class="chart-placeholder">Sem dados por simbolo</div>';
                return;
            }

            // Update stats
            if (data.best_symbol) {
                const bestEl = document.getElementById('best-symbol');
                bestEl.textContent = `${data.best_symbol.symbol} (${formatCurrency(data.best_symbol.total_pnl)})`;
                bestEl.style.color = '#10b981';
            }
            if (data.worst_symbol) {
                const worstEl = document.getElementById('worst-symbol');
                worstEl.textContent = `${data.worst_symbol.symbol} (${formatCurrency(data.worst_symbol.total_pnl)})`;
                worstEl.style.color = '#ef4444';
            }

            const symbols = data.symbols;
            const sortedSymbols = [...symbols].sort((a, b) => b.total_pnl - a.total_pnl);

            const trace = {
                x: sortedSymbols.map(s => s.symbol.replace('/USDT', '')),
                y: sortedSymbols.map(s => s.total_pnl),
                type: 'bar',
                marker: {
                    color: sortedSymbols.map(s => s.total_pnl >= 0 ? '#10b981' : '#ef4444'),
                    line: { color: '#151b28', width: 1 }
                },
                text: sortedSymbols.map(s => `${s.trades} trades | ${s.win_rate}% WR`),
                textposition: 'none',
                hovertemplate: '<b>%{x}</b><br>PnL: $%{y:.2f}<br>%{text}<extra></extra>'
            };

            const layout = {
                ...plotlyDarkLayout,
                yaxis: { ...plotlyDarkLayout.yaxis, tickprefix: '$', title: 'PnL Total', automargin: true },
                xaxis: { ...plotlyDarkLayout.xaxis, tickangle: -45, type: 'category', automargin: true },
                margin: { l: 70, r: 30, t: 30, b: 80 },
                bargap: 0.3,
                height: 320,
                shapes: [{
                    type: 'line',
                    x0: -0.5, x1: sortedSymbols.length - 0.5,
                    y0: 0, y1: 0,
                    line: { color: '#6b7280', width: 1, dash: 'dash' }
                }]
            };

            // Limpar container e remover classe placeholder antes de renderizar
            const container = document.getElementById('symbol-chart');
            container.innerHTML = '';
            container.classList.remove('chart-placeholder');
            Plotly.newPlot(container, [trace], layout, plotlyConfig);
        }

        // Update all charts
        async function updateCharts() {
            try {
                await Promise.all([
                    updateEquityChart(),
                    updateDrawdownChart(),
                    updatePnLHistogram(),
                    updateSymbolChart()
                ]);
            } catch (e) {
                console.error('Erro ao atualizar graficos:', e);
            }
        }

        // Charts only load when user expands the section (chartsLoaded flag)
        // Update charts every 10 seconds IF expanded
        setInterval(() => {
            if (chartsLoaded) {
                updateCharts();
            }
        }, SLOW_INTERVAL);
    </script>
</body>
</html>
