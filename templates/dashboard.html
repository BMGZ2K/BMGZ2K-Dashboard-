<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e17;
            color: #e1e5eb;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a1f2e 0%, #0d1117 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #2d3748;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }
        
        .header .status {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.testnet {
            background: #f59e0b20;
            color: #f59e0b;
            border: 1px solid #f59e0b40;
        }
        
        .status-badge.production {
            background: #10b98120;
            color: #10b981;
            border: 1px solid #10b98140;
        }
        
        .status-badge.halted {
            background: #ef444420;
            color: #ef4444;
            border: 1px solid #ef444440;
        }
        
        .last-update {
            font-size: 12px;
            color: #6b7280;
        }
        
        .container {
            padding: 20px;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: #151b28;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #2d3748;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .card-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .metric-value {
            font-size: 28px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 5px;
        }
        
        .metric-label {
            font-size: 12px;
            color: #6b7280;
        }
        
        .metric-change {
            font-size: 13px;
            font-weight: 500;
            margin-top: 8px;
        }
        
        .metric-change.positive {
            color: #10b981;
        }
        
        .metric-change.negative {
            color: #ef4444;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #3b82f6;
            border-radius: 2px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #2d3748;
        }
        
        th {
            font-size: 12px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            font-size: 14px;
            color: #e1e5eb;
        }
        
        tr:hover {
            background: #1a2234;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-long {
            background: #10b98120;
            color: #10b981;
        }
        
        .badge-short {
            background: #ef444420;
            color: #ef4444;
        }
        
        .badge-strategy {
            background: #3b82f620;
            color: #3b82f6;
        }
        
        .progress-bar {
            height: 8px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.positive {
            background: linear-gradient(90deg, #10b981, #34d399);
        }
        
        .progress-fill.negative {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }
        
        .logs-container {
            max-height: 300px;
            overflow-y: auto;
            background: #0d1117;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .log-line {
            padding: 4px 8px;
            border-bottom: 1px solid #1a2234;
            color: #9ca3af;
            font-size: 11px;
            word-wrap: break-word;
        }
        
        .log-line.info {
            color: #3b82f6;
        }
        
        .log-line.warning {
            color: #f59e0b;
        }
        
        .log-line.error {
            color: #ef4444;
            font-weight: 600;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }
        
        .fold-bars {
            display: flex;
            gap: 4px;
            margin-top: 10px;
        }
        
        .fold-bar {
            flex: 1;
            height: 30px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }
        
        .fold-bar.positive {
            background: #10b98130;
            color: #10b981;
        }
        
        .fold-bar.negative {
            background: #ef444430;
            color: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-indicator {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #151b28;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            border: 1px solid #2d3748;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #2d3748;
            position: sticky;
            top: 0;
            background: #151b28;
        }

        .modal-header h3 {
            color: #fff;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-close:hover {
            color: #fff;
        }

        .modal-body {
            padding: 20px;
        }

        .detail-section {
            margin-bottom: 25px;
        }

        .detail-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #2d3748;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .detail-item {
            background: #1a2234;
            padding: 12px;
            border-radius: 8px;
        }

        .detail-item-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-item-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .fold-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .fold-table th,
        .fold-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #2d3748;
        }

        .fold-table th {
            font-size: 11px;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
        }

        .fold-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fold-bar-bg {
            flex: 1;
            height: 20px;
            background: #2d3748;
            border-radius: 4px;
            overflow: hidden;
        }

        .fold-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .strategy-card {
            background: #1a2234;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 3px solid #3b82f6;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .strategy-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .strategy-card.active {
            border-left-color: #10b981;
        }

        .strategy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .strategy-name {
            font-weight: 600;
            color: #fff;
            font-size: 15px;
        }

        .strategy-metrics {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }

        .strategy-metric {
            text-align: center;
        }

        .strategy-metric-value {
            font-size: 16px;
            font-weight: 600;
            color: #fff;
        }

        .strategy-metric-label {
            font-size: 10px;
            color: #6b7280;
            text-transform: uppercase;
        }

        .active-badge {
            background: #10b98130;
            color: #10b981;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .params-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .param-tag {
            background: #3b82f620;
            color: #3b82f6;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
        }

        /* Indicador de conexão */
        .connection-error {
            background: #ef444420;
            border: 1px solid #ef4444;
            color: #ef4444;
            padding: 10px 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            display: none;
        }

        .connection-error.visible {
            display: block;
        }

        /* Spinner de carregamento */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #3b82f640;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Trading Dashboard</h1>
        <div class="status">
            <div class="live-indicator"></div>
            <span id="mode-badge" class="status-badge testnet">TESTNET</span>
            <span id="halted-badge" class="status-badge halted" style="display: none;">HALTED</span>
            <span class="last-update">Atualizado: <span id="last-update">--</span></span>
        </div>
    </div>
    
    <div class="container">
        <!-- Indicador de erro de conexão -->
        <div id="connection-error" class="connection-error">
            Erro de conexão com o servidor. Tentando reconectar...
        </div>

        <!-- Metricas Principais -->
        <div class="grid">
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Balance</span>
                    <div class="card-icon" style="background: #3b82f620; color: #3b82f6;">$</div>
                </div>
                <div class="metric-value" id="balance">$0.00</div>
                <div class="metric-label">USDT Disponivel</div>
                <div class="metric-change" id="return-pct">0.00%</div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Trades</span>
                    <div class="card-icon" style="background: #8b5cf620; color: #8b5cf6;">#</div>
                </div>
                <div class="metric-value" id="total-trades">0</div>
                <div class="metric-label">Total de Trades</div>
                <div id="wins-losses" style="margin-top: 8px; font-size: 13px;">
                    <span style="color: #10b981;">0 wins</span> / 
                    <span style="color: #ef4444;">0 losses</span>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Win Rate</span>
                    <div class="card-icon" style="background: #10b98120; color: #10b981;">%</div>
                </div>
                <div class="metric-value" id="win-rate">0%</div>
                <div class="metric-label">Taxa de Acerto</div>
                <div class="progress-bar">
                    <div class="progress-fill positive" id="win-rate-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">PnL Total</span>
                    <div class="card-icon" style="background: #f59e0b20; color: #f59e0b;">$</div>
                </div>
                <div class="metric-value" id="total-pnl">$0.00</div>
                <div class="metric-label">Realizado + Não Realizado</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Realizado:</span>
                        <span id="realized-pnl" style="color: #10b981;">$0.00</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Aberto:</span>
                        <span id="unrealized-pnl" style="color: #3b82f6;">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Margem</span>
                    <div class="card-icon" style="background: #06b6d420; color: #06b6d4;">◈</div>
                </div>
                <div class="metric-value" id="available-margin">$0</div>
                <div class="metric-label">Margem Disponivel</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Usada:</span>
                        <span id="used-margin" style="color: #f59e0b;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Manutencao:</span>
                        <span id="maint-margin" style="color: #ef4444;">$0</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Risco</span>
                    <div class="card-icon" style="background: #ef444420; color: #ef4444;">⚠</div>
                </div>
                <div class="metric-value" id="margin-ratio">0%</div>
                <div class="metric-label">Margin Ratio</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Margem Usada:</span>
                        <span id="margin-used-pct" style="color: #f59e0b;">0%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Drawdown:</span>
                        <span id="drawdown" style="color: #ef4444;">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Posicoes</span>
                    <div class="card-icon" style="background: #a855f720; color: #a855f7;">⚡</div>
                </div>
                <div class="metric-value" id="positions-count">0</div>
                <div class="metric-label">Posicoes Abertas</div>
                <div style="margin-top: 8px; font-size: 12px;">
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Notional:</span>
                        <span id="total-notional" style="color: #3b82f6;">$0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: #9ca3af;">Estrategia:</span>
                        <span id="active-strategy" style="color: #a855f7;">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Posicoes Abertas -->
        <div class="section">
            <h2 class="section-title">Posicoes Abertas <span id="total-unrealized-pnl" style="font-size: 14px; margin-left: 15px;"></span></h2>
            <div class="card">
                <table>
                    <thead>
                        <tr>
                            <th>Par</th>
                            <th>Lado</th>
                            <th>Lev</th>
                            <th>Estrategia</th>
                            <th>Entrada</th>
                            <th>Atual</th>
                            <th>Notional</th>
                            <th>PnL</th>
                            <th>SL (dist)</th>
                            <th>TP (dist)</th>
                            <th>Liq. Price</th>
                            <th>Razao</th>
                        </tr>
                    </thead>
                    <tbody id="positions-table">
                        <tr><td colspan="12" class="no-data">Nenhuma posicao aberta</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Historico de Trades -->
        <div class="section">
            <h2 class="section-title">Historico de Trades</h2>
            <div class="card">
                <div id="strategy-summary" style="margin-bottom: 15px; display: flex; gap: 15px; flex-wrap: wrap;"></div>
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Par</th>
                            <th>Lado</th>
                            <th>Estrategia</th>
                            <th>Entrada</th>
                            <th>Saida</th>
                            <th>Qtd</th>
                            <th>PnL</th>
                            <th>%</th>
                            <th>Razao Entrada</th>
                            <th>Razao Saida</th>
                            <th>Horario</th>
                        </tr>
                    </thead>
                    <tbody id="trades-table">
                        <tr><td colspan="12" class="no-data">Nenhum trade registrado</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Estrategias Validadas -->
        <div class="section">
            <h2 class="section-title">Estrategias Validadas (WFO)
                <span id="strategies-count" style="font-size: 14px; margin-left: 15px; color: #3b82f6;"></span>
            </h2>

            <div id="strategies-container">
                <div class="no-data">Carregando estrategias...</div>
            </div>
        </div>

        <!-- Modal de Detalhes da Estratégia -->
        <div id="strategy-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modal-title">Detalhes da Estratégia</h3>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div class="modal-body" id="modal-body">
                    <!-- Conteúdo carregado dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Logs do Sistema -->
        <div class="section">
            <h2 class="section-title">Logs do Sistema</h2>
            <div class="card">
                <div class="logs-container" id="logs-container">
                    <div class="no-data">Carregando logs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // ===== CONFIGURAÇÃO DE INTERVALOS DE ATUALIZAÇÃO =====
        // Tiered updates para melhor performance
        const FAST_INTERVAL = 3000;    // Status, Posições (3s)
        const MEDIUM_INTERVAL = 8000;  // Trades (8s)
        const SLOW_INTERVAL = 15000;   // Estratégias, Logs (15s)

        // Timestamp da última atualização bem-sucedida
        let lastSuccessfulUpdate = Date.now();
        const STALE_THRESHOLD_MS = 20000; // 20 segundos

        // Cache local para evitar chamadas duplicadas
        let statusDataCache = null;
        let statusCacheTime = 0;
        const STATUS_CACHE_TTL = 2000; // 2s cache local

        // ===== FUNÇÕES DE FORMATAÇÃO =====
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Formatação de preço inteligente (global)
        function formatPrice(price) {
            if (!price || isNaN(price)) return '$0.00';
            if (price >= 1000) return formatCurrency(price);
            if (price >= 1) return '$' + price.toFixed(4);
            if (price >= 0.01) return '$' + price.toFixed(5);
            return '$' + price.toFixed(8);
        }

        function formatPercent(value) {
            const sign = value >= 0 ? '+' : '';
            return sign + value.toFixed(2) + '%';
        }

        // Verifica se dados estão desatualizados
        function checkDataStaleness() {
            const now = Date.now();
            const staleDuration = now - lastSuccessfulUpdate;
            const indicator = document.getElementById('last-update');
            const parent = indicator ? indicator.parentElement : null;

            if (staleDuration > STALE_THRESHOLD_MS) {
                if (parent) parent.style.color = '#ef4444';
                if (indicator) indicator.textContent = 'DESATUALIZADO - ' + new Date(lastSuccessfulUpdate).toLocaleTimeString('pt-BR');
            } else {
                if (parent) parent.style.color = '#6b7280';
            }
        }

        function renderFoldBars(foldResults) {
            if (!foldResults || foldResults.length === 0) return '';
            const returns = foldResults.map(f => f.return_pct || 0);
            const maxRet = Math.max(...returns.map(r => Math.abs(r)), 1);

            let barsHtml = foldResults.map((f, i) => {
                const ret = f.return_pct || 0;
                const color = ret >= 0 ? '#10b981' : '#ef4444';
                const heightPct = (Math.abs(ret) / maxRet) * 100;
                return '<div style="flex: 1; display: flex; flex-direction: column; align-items: center;">' +
                    '<div style="background: #1a2234; height: 40px; width: 100%; border-radius: 4px; display: flex; align-items: flex-end; justify-content: center;">' +
                        '<div style="background: ' + color + '; height: ' + Math.max(4, heightPct * 0.4) + 'px; width: 70%; border-radius: 2px;"></div>' +
                    '</div>' +
                    '<span style="font-size: 9px; color: ' + color + '; margin-top: 3px; font-weight: 600;">' + ret.toFixed(0) + '%</span>' +
                    '<span style="font-size: 8px; color: #6b7280;">F' + (i+1) + '</span>' +
                '</div>';
            }).join('');

            return '<div style="margin-top: 12px;">' +
                '<div style="font-size: 11px; color: #6b7280; margin-bottom: 5px;">Retorno por Fold (Out-of-Sample):</div>' +
                '<div class="fold-bars" style="display: flex; gap: 4px;">' + barsHtml + '</div>' +
            '</div>';
        }

        function renderFoldTable(folds) {
            if (!folds || folds.length === 0) return '<div class="no-data">Sem detalhes de folds disponíveis</div>';
            const maxRet = Math.max(...folds.map(f => Math.abs(f.return_pct || 0)), 1);

            let rowsHtml = folds.map((f, i) => {
                const ret = f.return_pct || 0;
                const retColor = ret >= 0 ? '#10b981' : '#ef4444';
                const barWidth = (Math.abs(ret) / maxRet) * 100;
                const trainStart = f.train_start ? new Date(f.train_start).toLocaleDateString('pt-BR') : '-';
                const trainEnd = f.train_end ? new Date(f.train_end).toLocaleDateString('pt-BR') : '-';
                const testStart = f.test_start ? new Date(f.test_start).toLocaleDateString('pt-BR') : '-';
                const testEnd = f.test_end ? new Date(f.test_end).toLocaleDateString('pt-BR') : '-';

                return '<tr>' +
                    '<td><strong>Fold ' + (f.fold_number || i+1) + '</strong></td>' +
                    '<td style="font-size: 11px;"><div style="display: flex; align-items: center; gap: 5px;">' +
                        '<span style="width: 8px; height: 8px; background: #3b82f6; border-radius: 2px;"></span>' +
                        '<span>' + trainStart + ' → ' + trainEnd + '</span></div></td>' +
                    '<td style="font-size: 11px;"><div style="display: flex; align-items: center; gap: 5px;">' +
                        '<span style="width: 8px; height: 8px; background: #10b981; border-radius: 2px;"></span>' +
                        '<span>' + testStart + ' → ' + testEnd + '</span></div></td>' +
                    '<td><div class="fold-bar-container">' +
                        '<span style="color: ' + retColor + '; font-weight: 600; min-width: 55px;">' + ret.toFixed(1) + '%</span>' +
                        '<div class="fold-bar-bg" style="width: 80px;"><div class="fold-bar-fill" style="width: ' + barWidth + '%; background: ' + retColor + ';"></div></div>' +
                    '</div></td>' +
                    '<td style="color: #ef4444;">' + (f.max_drawdown_pct || 0).toFixed(1) + '%</td>' +
                    '<td style="color: #3b82f6;">' + (f.sharpe_ratio || 0).toFixed(2) + '</td>' +
                    '<td style="color: #f59e0b;">' + (f.profit_factor || 0).toFixed(2) + '</td>' +
                    '<td>' + (f.win_rate || 0).toFixed(0) + '%</td>' +
                    '<td>' + (f.total_trades || 0) + '</td>' +
                '</tr>';
            }).join('');

            return '<div class="detail-section">' +
                '<div class="detail-section-title">Walk-Forward: Resultados por Fold</div>' +
                '<div style="margin-bottom: 15px; padding: 12px; background: #1a2234; border-radius: 8px; font-size: 12px;">' +
                    '<div style="display: flex; gap: 20px; align-items: center;">' +
                        '<div style="display: flex; align-items: center; gap: 6px;">' +
                            '<span style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></span>' +
                            '<span style="color: #9ca3af;">In-Sample (Treino)</span>' +
                        '</div>' +
                        '<div style="display: flex; align-items: center; gap: 6px;">' +
                            '<span style="width: 12px; height: 12px; background: #10b981; border-radius: 2px;"></span>' +
                            '<span style="color: #9ca3af;">Out-of-Sample (Teste) - Retornos mostrados</span>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="overflow-x: auto;"><table class="fold-table"><thead><tr>' +
                    '<th>Fold</th><th>In-Sample (Treino)</th><th>Out-of-Sample (Teste)</th>' +
                    '<th>Retorno OOS</th><th>Max DD</th><th>Sharpe</th><th>PF</th><th>Win Rate</th><th>Trades</th>' +
                '</tr></thead><tbody>' + rowsHtml + '</tbody></table></div>' +
                '<div style="margin-top: 10px; padding: 10px; background: #0d1117; border-radius: 6px; font-size: 11px; color: #6b7280;">' +
                    '<strong>Nota:</strong> Os retornos mostrados são do período Out-of-Sample (dados não vistos durante otimização). ' +
                    'Parâmetros foram otimizados no período In-Sample e testados no Out-of-Sample para validar robustez.' +
                '</div></div>';
        }

        let connectionOk = true;
        let errorCount = 0;

        // Fetch com timeout real usando AbortController
        async function fetchWithTimeout(url, timeoutMs = 10000) {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            try {
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                return response;
            } catch (e) {
                clearTimeout(timeoutId);
                throw e;
            }
        }

        async function fetchData(endpoint) {
            try {
                const response = await fetchWithTimeout(endpoint, 10000);  // 10s timeout
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                // Verificar se tem erro na resposta
                if (data.error) {
                    console.warn('API retornou erro:', endpoint, data.error);
                    // Não incrementar errorCount se for erro de dados
                    return data;
                }

                // Conexão OK - atualizar timestamp
                lastSuccessfulUpdate = Date.now();
                if (!connectionOk) {
                    connectionOk = true;
                    errorCount = 0;
                    const errorEl = document.getElementById('connection-error');
                    if (errorEl) errorEl.classList.remove('visible');
                }
                return data;
            } catch (e) {
                if (e.name === 'AbortError') {
                    console.warn('Timeout (10s):', endpoint);
                } else {
                    console.warn('Erro fetch:', endpoint, e.message);
                }
                errorCount++;

                // Mostrar erro após 5 falhas consecutivas (mais tolerante)
                if (errorCount >= 5 && connectionOk) {
                    connectionOk = false;
                    const errorEl = document.getElementById('connection-error');
                    if (errorEl) errorEl.classList.add('visible');
                }
                return null;
            }
        }

        // Função para buscar status com cache local
        async function fetchStatus() {
            const now = Date.now();
            if (statusDataCache && (now - statusCacheTime) < STATUS_CACHE_TTL) {
                return statusDataCache;
            }
            const data = await fetchData('/api/status');
            if (data && !data.error) {
                statusDataCache = data;
                statusCacheTime = now;
            }
            return data;
        }
        
        async function updateStatus() {
            const data = await fetchStatus();
            if (!data || data.error) return;
            
            // Mode badge
            const modeBadge = document.getElementById('mode-badge');
            modeBadge.textContent = data.mode;
            modeBadge.className = 'status-badge ' + (data.mode === 'TESTNET' ? 'testnet' : 'production');
            
            // Halted badge
            const haltedBadge = document.getElementById('halted-badge');
            haltedBadge.style.display = data.is_halted ? 'inline-block' : 'none';
            
            // Last update
            document.getElementById('last-update').textContent = 
                new Date(data.timestamp).toLocaleTimeString('pt-BR');
        }
        
        async function updateMetrics() {
            const data = await fetchStatus();
            if (!data || data.error) return;
            
            // Balance (Margin Balance = wallet + unrealized PnL)
            document.getElementById('balance').textContent = formatCurrency(data.margin_balance || data.wallet_balance || 0);
            
            // Return
            const returnEl = document.getElementById('return-pct');
            returnEl.textContent = formatPercent(data.return_pct || 0);
            returnEl.className = 'metric-change ' + ((data.return_pct || 0) >= 0 ? 'positive' : 'negative');
            
            // Trades
            document.getElementById('total-trades').textContent = data.total_trades || 0;
            document.getElementById('wins-losses').innerHTML = 
                `<span style="color: #10b981;">${data.wins || 0} wins</span> / ` +
                `<span style="color: #ef4444;">${data.losses || 0} losses</span>`;
            
            // Win Rate
            document.getElementById('win-rate').textContent = (data.win_rate || 0).toFixed(1) + '%';
            document.getElementById('win-rate-bar').style.width = (data.win_rate || 0) + '%';
            
            // PnL Total
            const pnlEl = document.getElementById('total-pnl');
            pnlEl.textContent = formatCurrency(data.total_pnl || 0);
            pnlEl.style.color = (data.total_pnl || 0) >= 0 ? '#10b981' : '#ef4444';
            
            // PnL Realizado (histórico)
            const realizedEl = document.getElementById('realized-pnl');
            realizedEl.textContent = formatCurrency(data.realized_pnl || 0);
            realizedEl.style.color = (data.realized_pnl || 0) >= 0 ? '#10b981' : '#ef4444';
            
            // PnL Não Realizado (posições abertas)
            const unrealizedEl = document.getElementById('unrealized-pnl');
            unrealizedEl.textContent = formatCurrency(data.unrealized_pnl || 0);
            unrealizedEl.style.color = (data.unrealized_pnl || 0) >= 0 ? '#3b82f6' : '#ef4444';
            
            // Margem Disponível
            document.getElementById('available-margin').textContent = formatCurrency(data.available_balance || 0);
            document.getElementById('used-margin').textContent = formatCurrency(data.initial_margin || 0);
            document.getElementById('maint-margin').textContent = formatCurrency(data.maint_margin || 0);
            
            // Risco
            const marginRatio = data.margin_ratio || 0;
            const marginRatioEl = document.getElementById('margin-ratio');
            marginRatioEl.textContent = marginRatio.toFixed(2) + '%';
            marginRatioEl.style.color = marginRatio < 50 ? '#10b981' : marginRatio < 80 ? '#f59e0b' : '#ef4444';
            
            document.getElementById('margin-used-pct').textContent = (data.margin_used_pct || 0).toFixed(1) + '%';
            document.getElementById('drawdown').textContent = (data.drawdown_pct || 0).toFixed(2) + '%';
            
            // Posicoes
            document.getElementById('positions-count').textContent = data.open_positions || 0;
        }
        
        async function updatePositions() {
            const data = await fetchData('/api/positions');
            if (!data) return;
            
            document.getElementById('positions-count').textContent = data.count;
            
            // Mostrar PnL total nao realizado
            const totalPnl = data.total_unrealized_pnl || 0;
            const totalPnlEl = document.getElementById('total-unrealized-pnl');
            totalPnlEl.textContent = `PnL Aberto: ${formatCurrency(totalPnl)}`;
            totalPnlEl.style.color = totalPnl >= 0 ? '#10b981' : '#ef4444';
            
            // Calcular notional total
            const totalNotional = data.positions.reduce((sum, p) => sum + (p.notional || 0), 0);
            document.getElementById('total-notional').textContent = '$' + totalNotional.toLocaleString('en-US', {maximumFractionDigits: 0});
            
            const tbody = document.getElementById('positions-table');
            
            if (data.positions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">Nenhuma posicao aberta</td></tr>';
                totalPnlEl.textContent = 'PnL Aberto: $0.00';
                totalPnlEl.style.color = '#6b7280';
                document.getElementById('total-notional').textContent = '$0';
                return;
            }

            tbody.innerHTML = data.positions.map(p => {
                const pnlColor = p.unrealized_pnl >= 0 ? '#10b981' : '#ef4444';
                const sideClass = p.side === 'long' ? 'badge-long' : 'badge-short';
                const entryTime = new Date(p.entry_time).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                // Usar formatPrice global (já definida acima)
                
                return `
                    <tr>
                        <td><strong>${p.symbol}</strong></td>
                        <td><span class="badge ${sideClass}">${p.side.toUpperCase()}</span></td>
                        <td><span style="color: #a855f7; font-weight: 600;">${p.leverage}x</span></td>
                        <td><span class="badge badge-strategy">${p.strategy || 'N/A'}</span></td>
                        <td>${formatPrice(p.entry_price)}</td>
                        <td>${formatPrice(p.current_price)}</td>
                        <td>$${p.notional.toLocaleString()}</td>
                        <td style="color: ${pnlColor}; font-weight: 600;">
                            ${formatCurrency(p.unrealized_pnl)}<br>
                            <span style="font-size: 10px;">${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct}%</span>
                        </td>
                        <td style="color: #ef4444;">
                            ${formatPrice(p.stop_loss)}<br>
                            <span style="font-size: 10px;">${p.sl_distance}%</span>
                        </td>
                        <td style="color: #10b981;">
                            ${formatPrice(p.take_profit)}<br>
                            <span style="font-size: 10px;">${p.tp_distance}%</span>
                        </td>
                        <td style="color: #f59e0b; font-size: 11px;">
                            ${p.liquidation_price > 0 ? formatPrice(p.liquidation_price) : '-'}
                        </td>
                        <td style="font-size: 10px; max-width: 100px; overflow: hidden; text-overflow: ellipsis;" title="${p.reason_entry}">
                            ${p.reason_entry || '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Armazenar dados das estratégias para o modal
        let strategiesData = [];

        async function updateStrategies() {
            const data = await fetchData('/api/strategies');
            if (!data) return;

            document.getElementById('active-strategy').textContent = data.active_strategy;
            strategiesData = data.validated_strategies || [];

            const container = document.getElementById('strategies-container');
            const countEl = document.getElementById('strategies-count');

            if (countEl) {
                countEl.textContent = `${data.total_strategies || 0} estratégias | ${data.active_count || 0} ativas`;
            }

            if (!strategiesData.length) {
                container.innerHTML = '<div class="no-data">Nenhuma estrategia validada. Execute o auto_evolve.py para criar.</div>';
                return;
            }

            container.innerHTML = strategiesData.map((s, idx) => {
                const robustnessColor = s.robustness >= 70 ? '#10b981' : s.robustness >= 40 ? '#f59e0b' : '#ef4444';
                const robustnessBg = robustnessColor + '20';
                const returnColor = (s.avg_return || 0) >= 0 ? '#10b981' : '#ef4444';

                return '<div class="strategy-card' + (s.is_active ? ' active' : '') + '" onclick="showStrategyDetail(\'' + s.id + '\')">' +
                    '<div class="strategy-header">' +
                        '<div>' +
                            '<span class="strategy-name">' + (s.name || s.strategy_type) + '</span>' +
                            (s.is_active ? '<span class="active-badge" style="margin-left: 10px;">ATIVA</span>' : '') +
                        '</div>' +
                        '<div style="display: flex; gap: 10px; align-items: center;">' +
                            '<span class="badge badge-strategy">' + s.num_folds + ' folds</span>' +
                            '<span class="badge" style="background: ' + robustnessBg + '; color: ' + robustnessColor + ';">' +
                                (s.robustness || 0).toFixed(0) + '% robusto' +
                            '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="strategy-metrics">' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: ' + returnColor + ';">' + (s.avg_return || 0).toFixed(1) + '%</div>' +
                            '<div class="strategy-metric-label">Ret/Fold OOS</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="font-size: 14px; color: #9ca3af;">' + (s.min_return || 0).toFixed(0) + '/' + (s.max_return || 0).toFixed(0) + '%</div>' +
                            '<div class="strategy-metric-label">Min/Max</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #ef4444;">' + (s.max_drawdown || 0).toFixed(1) + '%</div>' +
                            '<div class="strategy-metric-label">Max DD</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #3b82f6;">' + (s.avg_sharpe || 0).toFixed(2) + '</div>' +
                            '<div class="strategy-metric-label">Sharpe</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #f59e0b;">' + (s.avg_profit_factor || 0).toFixed(2) + '</div>' +
                            '<div class="strategy-metric-label">Profit Factor</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #a855f7;">' + (s.avg_win_rate || 0).toFixed(0) + '%</div>' +
                            '<div class="strategy-metric-label">Win Rate</div>' +
                        '</div>' +
                        '<div class="strategy-metric">' +
                            '<div class="strategy-metric-value" style="color: #06b6d4;">' + (s.total_trades || 0) + '</div>' +
                            '<div class="strategy-metric-label">Trades</div>' +
                        '</div>' +
                    '</div>' +
                    (s.fold_results && s.fold_results.length > 0 ? renderFoldBars(s.fold_results) : '') +
                    '<div style="margin-top: 10px; font-size: 11px; color: #6b7280;">' +
                        'Clique para ver detalhes completos' +
                    '</div>' +
                '</div>';
            }).join('');
        }

        async function showStrategyDetail(strategyId) {
            const modal = document.getElementById('strategy-modal');
            const modalBody = document.getElementById('modal-body');
            const modalTitle = document.getElementById('modal-title');

            modalBody.innerHTML = '<div class="no-data">Carregando...</div>';
            modal.style.display = 'flex';

            try {
                const data = await fetchData(`/api/strategies/${strategyId}`);
                if (!data || data.error) {
                    modalBody.innerHTML = `<div class="no-data">Erro: ${data?.error || 'Estratégia não encontrada'}</div>`;
                    return;
                }

                modalTitle.textContent = `${data.name} - Detalhes Completos`;

                const metrics = data.metrics || {};
                const wfo = data.wfo || {};
                const status = data.status || {};
                const folds = wfo.fold_results || [];

                modalBody.innerHTML = `
                    <!-- Status -->
                    <div class="detail-section">
                        <div class="detail-section-title">Status</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Status</div>
                                <div class="detail-item-value" style="color: ${status.is_active ? '#10b981' : '#6b7280'};">
                                    ${status.is_active ? 'ATIVA' : 'INATIVA'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Tipo</div>
                                <div class="detail-item-value">${data.strategy_type}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Timeframe</div>
                                <div class="detail-item-value">${data.timeframe}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Símbolos</div>
                                <div class="detail-item-value">${(data.symbols || []).length}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Criada em</div>
                                <div class="detail-item-value" style="font-size: 12px;">
                                    ${status.created_at ? new Date(status.created_at).toLocaleString('pt-BR') : '-'}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Último Uso</div>
                                <div class="detail-item-value" style="font-size: 12px;">
                                    ${status.last_used ? new Date(status.last_used).toLocaleString('pt-BR') : 'Nunca'}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Métricas WFO -->
                    <div class="detail-section">
                        <div class="detail-section-title">Métricas WFO (${wfo.num_folds} Folds)</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Retorno Médio</div>
                                <div class="detail-item-value" style="color: ${metrics.avg_return >= 0 ? '#10b981' : '#ef4444'};">
                                    ${(metrics.avg_return || 0).toFixed(2)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Retorno Min/Max</div>
                                <div class="detail-item-value" style="font-size: 14px;">
                                    <span style="color: #ef4444;">${(metrics.min_return || 0).toFixed(1)}%</span> /
                                    <span style="color: #10b981;">${(metrics.max_return || 0).toFixed(1)}%</span>
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Desvio Padrão</div>
                                <div class="detail-item-value">${(metrics.std_return || 0).toFixed(2)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Max Drawdown</div>
                                <div class="detail-item-value" style="color: #ef4444;">
                                    ${(metrics.max_drawdown || 0).toFixed(2)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Sharpe Médio</div>
                                <div class="detail-item-value" style="color: #3b82f6;">
                                    ${(metrics.avg_sharpe || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Sortino Médio</div>
                                <div class="detail-item-value" style="color: #8b5cf6;">
                                    ${(metrics.avg_sortino || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Profit Factor</div>
                                <div class="detail-item-value" style="color: #f59e0b;">
                                    ${(metrics.avg_profit_factor || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Win Rate</div>
                                <div class="detail-item-value">${(metrics.avg_win_rate || 0).toFixed(1)}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Score WFO</div>
                                <div class="detail-item-value" style="color: #06b6d4;">
                                    ${(wfo.wfo_score || 0).toFixed(2)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Robustez</div>
                                <div class="detail-item-value" style="color: ${(wfo.robustness || wfo.robustness_score || 0) >= 70 ? '#10b981' : '#f59e0b'};">
                                    ${(wfo.robustness || wfo.robustness_score || 0).toFixed(1)}%
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Total Trades</div>
                                <div class="detail-item-value">${metrics.total_trades || 0}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalhes por Fold -->
                    ` + renderFoldTable(folds) + `

                    <!-- Parâmetros -->
                    <div class="detail-section">
                        <div class="detail-section-title">Parâmetros da Estratégia</div>
                        <div class="params-list">
                            ${Object.entries(data.params || {}).map(([k, v]) =>
                                `<span class="param-tag">${k}: ${typeof v === 'number' ? v.toFixed ? v.toFixed(2) : v : v}</span>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Performance Real -->
                    <div class="detail-section">
                        <div class="detail-section-title">Performance Real (Live Trading)</div>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-item-label">Trades Reais</div>
                                <div class="detail-item-value">${data.real_performance?.trades || 0}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">PnL Real</div>
                                <div class="detail-item-value" style="color: ${(data.real_performance?.pnl || 0) >= 0 ? '#10b981' : '#ef4444'};">
                                    ${formatCurrency(data.real_performance?.pnl || 0)}
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-item-label">Win Rate Real</div>
                                <div class="detail-item-value">${(data.real_performance?.win_rate || 0).toFixed(1)}%</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (e) {
                modalBody.innerHTML = `<div class="no-data">Erro ao carregar: ${e.message}</div>`;
            }
        }

        function closeModal() {
            document.getElementById('strategy-modal').style.display = 'none';
        }

        // Fechar modal ao clicar fora
        document.getElementById('strategy-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        async function updateTrades() {
            const data = await fetchData('/api/trades');
            if (!data) return;
            
            // Resumo por estrategia
            const summaryContainer = document.getElementById('strategy-summary');
            const stratStats = data.strategy_stats || {};
            
            if (Object.keys(stratStats).length > 0) {
                summaryContainer.innerHTML = Object.entries(stratStats).map(([strat, stats]) => `
                    <div style="background: #1a2234; padding: 10px 15px; border-radius: 8px; min-width: 150px;">
                        <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase;">${strat}</div>
                        <div style="font-size: 18px; font-weight: 600; color: ${stats.pnl >= 0 ? '#10b981' : '#ef4444'};">
                            ${formatCurrency(stats.pnl)}
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            ${stats.trades} trades | ${stats.win_rate.toFixed(1)}% WR
                        </div>
                    </div>
                `).join('');
            } else {
                summaryContainer.innerHTML = '';
            }
            
            // Tabela de trades
            const tbody = document.getElementById('trades-table');
            const trades = data.recent_trades || [];
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="no-data">Nenhum trade registrado</td></tr>';
                return;
            }
            
            tbody.innerHTML = trades.map(t => {
                const pnlColor = t.pnl >= 0 ? '#10b981' : '#ef4444';
                const sideClass = t.side === 'long' ? 'badge-long' : 'badge-short';
                const exitTime = new Date(t.exit_time).toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit'
                });

                // Formatar quantidade de forma inteligente
                const qty = parseFloat(t.quantity);
                const qtyFormatted = qty >= 1000 ? qty.toLocaleString('en-US', {maximumFractionDigits: 2}) :
                                     qty >= 1 ? qty.toFixed(4) : qty.toPrecision(4);

                return `
                    <tr>
                        <td>${t.id || '-'}</td>
                        <td><strong>${t.symbol}</strong></td>
                        <td><span class="badge ${sideClass}">${t.side.toUpperCase()}</span></td>
                        <td><span class="badge badge-strategy">${t.strategy || 'N/A'}</span></td>
                        <td>${formatPrice(t.entry_price)}</td>
                        <td>${formatPrice(t.exit_price)}</td>
                        <td>${qtyFormatted}</td>
                        <td style="color: ${pnlColor}; font-weight: 600;">${formatCurrency(t.pnl)}</td>
                        <td style="color: ${pnlColor};">${(t.pnl_pct || 0).toFixed(2)}%</td>
                        <td style="font-size: 11px; max-width: 150px; overflow: hidden; text-overflow: ellipsis;">${t.reason_entry || '-'}</td>
                        <td style="font-size: 11px;">${t.reason_exit || '-'}</td>
                        <td style="font-size: 11px;">${exitTime}</td>
                    </tr>
                `;
            }).join('');
        }
        
        async function updateLogs() {
            const data = await fetchData('/api/logs');
            if (!data || !data.logs) return;
            
            const container = document.getElementById('logs-container');
            
            if (data.logs.length === 0) {
                container.innerHTML = '<div class="no-data">Nenhum log disponivel</div>';
                return;
            }
            
            container.innerHTML = data.logs.slice(-50).map(log => {
                let className = 'log-line';
                if (log.includes('ERROR')) className += ' error';
                else if (log.includes('WARNING')) className += ' warning';
                else if (log.includes('INFO')) className += ' info';
                return `<div class="${className}">${log}</div>`;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        // ===== FUNÇÕES DE ATUALIZAÇÃO AGRUPADAS =====
        async function updateFast() {
            // Status/Métricas (mesma chamada com cache) e Posições
            // Status e Metrics usam fetchStatus() que tem cache local
            await updateStatus();
            await updateMetrics();
            await updatePositions();
        }

        async function updateMedium() {
            // Trades (8s)
            await updateTrades();
        }

        async function updateSlow() {
            // Estratégias e Logs (15s)
            await Promise.all([
                updateStrategies(),
                updateLogs()
            ]);
        }

        async function updateAll() {
            // Carrega tudo sequencialmente para evitar sobrecarga inicial
            await updateFast();
            await updateMedium();
            await updateSlow();
        }

        // ===== INICIAR ATUALIZAÇÕES =====
        // Carregar tudo inicialmente (com pequeno delay para dar tempo ao servidor)
        setTimeout(updateAll, 500);

        // Intervalos diferentes para cada tipo de dado
        setInterval(updateFast, FAST_INTERVAL);      // 3s - posições, status, métricas
        setInterval(updateMedium, MEDIUM_INTERVAL);  // 8s - trades
        setInterval(updateSlow, SLOW_INTERVAL);      // 15s - estratégias e logs

        // Verificar dados desatualizados a cada 2s
        setInterval(checkDataStaleness, 2000);

        // Fechar modal com Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('strategy-modal');
                if (modal && modal.style.display === 'flex') {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>
